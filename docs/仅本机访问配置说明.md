# 仅本机访问配置说明

后端、数据库、AI 服务仅监听本机（127.0.0.1），对外只通过 Nginx 的 80/443 提供前端和 API。

## 已完成的配置

- **后端 (Node.js 3000)**：`HOST=127.0.0.1`，仅本机监听；Nginx 将 `/api` 代理到 `http://127.0.0.1:3000/api`。
- **AI 服务 (8000)**：uvicorn `--host 127.0.0.1`；Nginx 将 `/ai-api/` 代理到 `http://127.0.0.1:8000/api/`。
- **前端**：生产环境 `AI_API_BASE_URL=/ai-api`，请求走同源再由 Nginx 转发到本机 AI。

## MySQL 仅本机访问

1. 编辑配置文件（任选其一）：
   - RHEL/CentOS：`/etc/my.cnf`
   - Debian/Ubuntu：`/etc/mysql/mysql.conf.d/mysqld.cnf`

2. 在 `[mysqld]` 下设置：
   ```ini
   [mysqld]
   bind-address = 127.0.0.1
   ```

3. 重启 MySQL：
   ```bash
   systemctl restart mysqld   # RHEL/CentOS
   systemctl restart mysql    # Debian/Ubuntu
   ```

4. 确认后端 `.env` 中为 `DB_HOST=127.0.0.1`（已配置则无需改）。

## 防火墙：仅开放 80/443

在服务器上执行（需 root）：

```bash
# 若使用 firewalld，移除 3000/3306/8000 的对外端口
sudo bash scripts/restrict-services-to-localhost.sh
```

或手动：

```bash
sudo firewall-cmd --permanent --remove-port=3000/tcp
sudo firewall-cmd --permanent --remove-port=3306/tcp
sudo firewall-cmd --permanent --remove-port=8000/tcp
sudo firewall-cmd --reload
```

确保 80、443 仍在 public 的 services 或 ports 中（一般 `http`、`https` 已包含）。

## 部署与重启顺序

1. 重新部署前端（更新 Nginx 配置与前端构建）：
   ```bash
   cd frontend && ./deploy-frontend.sh --build
   ```

2. 重启后端（使 HOST=127.0.0.1 生效）：
   ```bash
   cd backend_server && pm2 restart gesp-api
   ```

3. 重启 AI 服务（使 --host 127.0.0.1 生效）：
   ```bash
   cd Al_server && ./stop.sh && ./start.sh
   ```

4. 执行防火墙脚本（若尚未执行）：
   ```bash
   sudo bash scripts/restrict-services-to-localhost.sh
   ```

5. 按上文配置 MySQL `bind-address` 并重启 MySQL。

## 验证

- 外网仅能访问：`https://你的域名`（80/443）。
- 外网无法访问：`http://服务器IP:3000`、`:3306`、`:8000`。
- 本机可访问：`curl http://127.0.0.1:3000/api/health`、`curl http://127.0.0.1:8000/`（若 AI 有根路径）。
