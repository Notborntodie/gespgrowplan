# 提取各级别答错频率最高的题目 - 使用说明

## 📋 功能说明

本工具用于从数据库中提取每个级别（GESP 1-6级）答错频率最高的50道客观题题目，并统计每道题最容易错的选项。

**主要功能：**
1. 按级别逐个处理，提取每个级别答错频率最高的50道题目
2. 统计每道高频错题中每个选项被选错的次数
3. 找出每道题最容易错的选项（被选错次数最多的选项）
4. 导出为JSON和CSV格式，便于分析

## 📁 文件说明

1. **`提取各级别答错频率最高的题目.sql`** - SQL查询脚本，可直接在MySQL中执行
2. **`scripts/extract_top_wrong_questions.js`** - Node.js脚本，自动执行查询并导出结果

## 🚀 使用方法

### 方法一：使用Node.js脚本（推荐）

这是最简单的方法，脚本会自动执行查询并导出结果。

```bash
cd /root/SmartOI/gesp-practice-system/backend_server
node scripts/extract_top_wrong_questions.js
```

**输出位置：**
- 结果文件保存在 `database/wrong_questions_export/` 目录
- 包含JSON和CSV两种格式
- 按级别分别导出，也提供完整数据文件

**生成的文件：**
- `top_wrong_questions_all_[时间戳].json` - 所有级别的完整数据（JSON）
- `top_wrong_questions_all_[时间戳].csv` - 所有级别的完整数据（CSV）
- `top_wrong_questions_level_1_[时间戳].json` - 级别1的数据（JSON）
- `top_wrong_questions_level_1_[时间戳].csv` - 级别1的数据（CSV）
- ... 其他级别类似

### 方法二：直接执行SQL脚本

如果您想直接在MySQL中执行查询：

```bash
# 方式1：在MySQL命令行中执行
mysql -u gesp_user -p gesp_practice_system < database/提取各级别答错频率最高的题目.sql

# 方式2：登录MySQL后执行
mysql -u gesp_user -p
USE gesp_practice_system;
SOURCE database/提取各级别答错频率最高的题目.sql;

# 方式3：导出为CSV
mysql -u gesp_user -p gesp_practice_system \
  -e "SELECT ..." > result.csv
```

## 📊 数据字段说明

### JSON格式数据字段

导出的JSON数据包含以下字段：

**题目基本信息：**
| 字段名 | 说明 | 类型 |
|--------|------|------|
| level | 题目级别（1-6） | int |
| question_id | 题目ID | int |
| question_text | 题目内容 | text |
| question_type | 题目类型（text/code） | enum |
| difficulty | 难度（easy/medium/hard） | enum |
| correct_answer | 正确答案 | varchar(10) |
| wrong_count | 答错次数 | int |
| total_attempts | 总答题次数 | int |
| correct_count | 答对次数 | int |
| wrong_rate | 错误率（%） | decimal |
| correct_rate | 正确率（%） | decimal |
| rank_in_level | 在该级别中的排名 | int |

**选项统计信息：**
| 字段名 | 说明 | 类型 |
|--------|------|------|
| options_statistics | 所有选项的统计信息（数组） | array |
| options_statistics[].option_value | 选项值（如'A', 'B'） | varchar(10) |
| options_statistics[].option_label | 选项标签 | varchar(10) |
| options_statistics[].option_text | 选项文本内容 | text |
| options_statistics[].wrong_count | 该选项被选错的次数 | int |
| most_wrong_option | 最容易错的选项（对象） | object |
| most_wrong_option.option_value | 最容易错的选项值 | varchar(10) |
| most_wrong_option.option_label | 最容易错的选项标签 | varchar(10) |
| most_wrong_option.option_text | 最容易错的选项文本 | text |
| most_wrong_option.wrong_count | 该选项被选错的次数 | int |

### CSV格式数据字段

CSV文件包含以下字段（扁平化处理）：
- level, question_id, question_text, question_type, difficulty, correct_answer
- wrong_count, total_attempts, correct_count, wrong_rate, correct_rate, rank_in_level
- most_wrong_option_value, most_wrong_option_label, most_wrong_option_text, most_wrong_option_count

## 🔍 查询逻辑

1. **按级别逐个处理**：一个级别一个级别地处理，确保数据清晰
2. **统计答错次数**：统计每道题在 `submission_answers` 表中 `is_correct = 0` 的记录数
3. **按级别分组**：根据 `questions.level` 字段分组
4. **排序规则**：
   - 首先按答错次数降序排列
   - 答错次数相同时，按总答题次数降序排列
5. **取前50道**：每个级别取答错次数最多的50道题目
6. **选项统计**：
   - 对于每道高频错题，统计每个选项被选错的次数
   - 找出最容易错的选项（被选错次数最多的选项）
   - 计算该选项在所有错误答案中的占比

## ⚙️ 配置说明

### 修改每级别提取的题目数量

编辑 `scripts/extract_top_wrong_questions.js` 文件：

```javascript
const MAX_QUESTIONS_PER_LEVEL = 50;  // 修改为您需要的数量
```

### 修改输出目录

编辑 `scripts/extract_top_wrong_questions.js` 文件：

```javascript
const OUTPUT_DIR = path.join(__dirname, '../database/wrong_questions_export');
```

## 📈 统计信息

脚本执行时会显示以下统计信息：

1. **每个级别的统计**：
   - 题目数量
   - 总答错次数
   - 总答题次数
   - 平均错误率

2. **整体统计**：
   - 每个级别有答题记录的题目总数
   - 每个级别的整体错误率

## 🔧 兼容性说明

- **MySQL 8.0+**：使用窗口函数 `ROW_NUMBER()`，性能更好
- **MySQL 5.7及以下**：使用变量方式实现排名，兼容性更好

脚本会自动检测MySQL版本并选择合适的方法。

## 📝 注意事项

1. **数据要求**：只统计有答题记录的题目（`submission_answers` 表中有记录）
2. **答错定义**：`is_correct = 0` 的记录视为答错
3. **文件编码**：CSV文件使用UTF-8编码，并包含BOM，可在Excel中正确显示中文
4. **数据库连接**：确保 `.env` 文件中的数据库配置正确

## 🐛 常见问题

### 问题1：找不到数据库连接

**解决方案：**
- 确保 `.env` 文件存在且配置正确
- 检查数据库服务是否运行
- 验证数据库用户权限

### 问题2：查询速度慢

**解决方案：**
- 确保 `questions.id` 和 `submission_answers.question_id` 上有索引
- 确保 `submission_answers.is_correct` 上有索引
- 如果数据量很大，考虑在业务低峰期执行

### 问题3：导出文件为空

**可能原因：**
- 数据库中没有答题记录
- 所有题目的答错次数都为0

**解决方案：**
- 检查 `submission_answers` 表中是否有数据
- 检查查询条件是否正确

## 📞 技术支持

如有问题，请检查：
1. 数据库连接配置
2. 数据库表结构是否正确
3. 是否有足够的权限执行查询

---

**最后更新：** 2025-01-20

