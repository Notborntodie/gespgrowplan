# 远程数据库同步方案

本文档说明如何在新服务器上通过远程连接旧服务器的数据库，同步所有数据到新服务器。

## 📋 方案概述

**方案流程：**
1. 旧服务器提供数据库连接信息（IP、端口、用户名、密码）
2. 新服务器通过远程连接访问旧数据库
3. 在新服务器上导出数据并导入到本地数据库
4. 配置后端应用连接新服务器的本地数据库·

## 🔧 前置准备

### 旧服务器需要提供的信息

- **数据库 IP 地址**：例如 `192.168.1.100`
- **数据库端口**：通常是 `3306`
- **数据库用户名**：例如 `gesp_user` 
- **数据库密码**：对应的密码
- **数据库名称**：`gesp_practice_system`

### 新服务器需要安装

- MySQL 8.0+ 或 MySQL 5.7+
- MySQL 客户端工具

## 🚀 同步步骤

### 步骤 1：在新服务器上安装 MySQL

**CentOS/RHEL/AlmaLinux:**
```bash
# 安装 MySQL
sudo yum install -y mysql-server mysql

# 启动 MySQL 服务
sudo systemctl start mysqld
sudo systemctl enable mysqld

# 安全配置（设置root密码）
sudo mysql_secure_installation
```

**Ubuntu/Debian:**
```bash
# 安装 MySQL
sudo apt update
sudo apt install -y mysql-server mysql-client

# 启动 MySQL 服务
sudo systemctl start mysql
sudo systemctl enable mysql

# 安全配置
sudo mysql_secure_installation
```

### 步骤 2：测试远程数据库连接

使用旧服务器提供的连接信息测试连接：

```bash
# 测试连接（替换为实际信息）
mysql -h <旧服务器IP> -P <端口> -u <用户名> -p

# 示例
mysql -h 106.14.143.27 -P 3306 -u gesp_user -p
```

如果连接成功，说明网络和权限都正常。

### 步骤 3：在新服务器上创建本地数据库

```bash
# 登录本地 MySQL
mysql -u root -p
```

```sql
-- 创建数据库
CREATE DATABASE gesp_practice_system 
CHARACTER SET utf8mb4 
COLLATE utf8mb4_unicode_ci;

-- 创建本地数据库用户（用于应用连接）
CREATE USER 'gesp_user'@'localhost' IDENTIFIED BY 'your_strong_password';

-- 授予权限
GRANT ALL PRIVILEGES ON gesp_practice_system.* TO 'gesp_user'@'localhost';

-- 刷新权限
FLUSH PRIVILEGES;

EXIT;
```

### 步骤 4：从远程数据库导出数据

**方法一：使用 mysqldump 直接导出到本地（推荐）**

```bash
# 从远程数据库导出并直接导入到本地数据库
mysqldump -h <旧服务器IP> \
          -P <端口> \
          -u <用户名> \
          -p<密码> \
          --single-transaction \
          --routines \
          --triggers \
          gesp_practice_system | mysql -u root -p gesp_practice_system

# 示例（密码在 -p 后面直接写，注意没有空格）
mysqldump -h 106.14.143.27 \
          -P 3306 \
          -u gesp_user \
          -p'Gesp@2025!' \
          --single-transaction \
          --routines \
          --triggers \
          gesp_practice_system | mysql -u root -p gesp_practice_system
```

**方法二：先导出到文件，再导入**

```bash
# 1. 导出远程数据库到文件
mysqldump -h <旧服务器IP> \
          -P <端口> \
          -u <用户名> \
          -p<密码> \
          --single-transaction \
          --routines \
          --triggers \
          gesp_practice_system > remote_dump.sql

# 示例
mysqldump -h 106.14.143.27 \
          -P 3306 \
          -u gesp_user \
          -p'Gesp@2025!' \
          --single-transaction \
          --routines \
          --triggers \
          gesp_practice_system > remote_dump.sql

# 2. 导入到本地数据库
mysql -u root -p gesp_practice_system < remote_dump.sql

# 3. 删除临时文件（可选）
rm remote_dump.sql
```

**mysqldump 参数说明：**
- `--single-transaction`：确保数据一致性，适用于 InnoDB 表
- `--routines`：导出存储过程和函数
- `--triggers`：导出触发器
- `-p<密码>`：注意密码紧跟在 -p 后面，没有空格

### 步骤 5：验证数据同步

```bash
# 检查表是否导入成功
mysql -u root -p gesp_practice_system -e "SHOW TABLES;"

# 检查主要表的数据量
mysql -u root -p gesp_practice_system << EOF
SELECT 
    'users' as table_name, COUNT(*) as count FROM users
UNION ALL
SELECT 'exams', COUNT(*) FROM exams
UNION ALL
SELECT 'questions', COUNT(*) FROM questions
UNION ALL
SELECT 'oj_problems', COUNT(*) FROM oj_problems
UNION ALL
SELECT 'submissions', COUNT(*) FROM submissions;
EOF
```

### 步骤 6：配置后端 .env 文件

在新服务器上配置后端应用连接本地数据库：

```bash
cd /root/SmartOI/gesp-practice-system/backend_server
nano .env
```

配置内容：

```env
# ============================================
# 应用配置
# ============================================
NODE_ENV=production
PORT=3000

# ============================================
# 数据库配置（连接本地数据库）
# ============================================
# 数据库主机地址（本地数据库）
DB_HOST=localhost
# 数据库端口
DB_PORT=3306
# 数据库名称
DB_NAME=gesp_practice_system
# 数据库用户名（本地创建的用户）
DB_USER=gesp_user
# 数据库密码（本地用户的密码）
DB_PASSWORD=your_strong_password

# 数据库连接池配置（可选）
DB_CONNECTION_LIMIT=20
DB_ACQUIRE_TIMEOUT=60000
DB_TIMEOUT=60000
DB_MAX_IDLE=60000
DB_IDLE_TIMEOUT=60000

# ============================================
# Redis 配置
# ============================================
REDIS_HOST=127.0.0.1
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DB=0

# ============================================
# 文件上传配置
# ============================================
UPLOAD_PATH=./uploads
MAX_FILE_SIZE=10485760
```

**重要说明：**
- `DB_HOST` 设置为 `localhost`（连接本地数据库）
- `DB_USER` 和 `DB_PASSWORD` 使用步骤 3 中创建的本地用户信息
- **不是**使用旧服务器的数据库用户信息

### 步骤 7：验证后端连接

```bash
cd /root/SmartOI/gesp-practice-system/backend_server

# 测试数据库连接
node -e "
require('dotenv').config();
const mysql = require('mysql2/promise');
(async () => {
  try {
    const connection = await mysql.createConnection({
      host: process.env.DB_HOST,
      port: process.env.DB_PORT,
      user: process.env.DB_USER,
      password: process.env.DB_PASSWORD,
      database: process.env.DB_NAME
    });
    console.log('✅ 数据库连接成功！');
    await connection.end();
  } catch (error) {
    console.error('❌ 数据库连接失败:', error.message);
    process.exit(1);
  }
})();
"

# 启动后端服务测试
npm start

# 检查健康状态
curl http://localhost:3000/health
```

## 🔄 自动化同步脚本

为了方便操作，可以创建一个自动化同步脚本：

```bash
#!/bin/bash
# 文件名：sync_remote_database.sh
# 使用方法：./sync_remote_database.sh

set -e

# 颜色输出
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}远程数据库同步脚本${NC}"
echo -e "${GREEN}========================================${NC}"
echo ""

# 配置信息（请修改为实际值）
REMOTE_HOST="106.14.143.27"      # 旧服务器IP
REMOTE_PORT="3306"               # 数据库端口
REMOTE_USER="gesp_user"          # 远程数据库用户名
REMOTE_PASSWORD="Gesp@2025!"     # 远程数据库密码
REMOTE_DB="gesp_practice_system" # 数据库名称

LOCAL_DB="gesp_practice_system"  # 本地数据库名称
LOCAL_USER="root"                # 本地MySQL用户
LOCAL_PASSWORD=""                # 本地MySQL密码（如果为空，会提示输入）

echo "配置信息："
echo "  远程服务器: ${REMOTE_HOST}:${REMOTE_PORT}"
echo "  远程数据库: ${REMOTE_DB}"
echo "  本地数据库: ${LOCAL_DB}"
echo ""

# 测试远程连接
echo -e "${YELLOW}正在测试远程数据库连接...${NC}"
if mysql -h ${REMOTE_HOST} -P ${REMOTE_PORT} -u ${REMOTE_USER} -p${REMOTE_PASSWORD} -e "SELECT 1;" ${REMOTE_DB} > /dev/null 2>&1; then
    echo -e "${GREEN}✓ 远程数据库连接成功${NC}"
else
    echo -e "${RED}✗ 远程数据库连接失败，请检查配置${NC}"
    exit 1
fi

# 检查本地数据库是否存在
echo -e "${YELLOW}正在检查本地数据库...${NC}"
if [ -z "$LOCAL_PASSWORD" ]; then
    MYSQL_CMD="mysql -u ${LOCAL_USER} -p"
else
    MYSQL_CMD="mysql -u ${LOCAL_USER} -p${LOCAL_PASSWORD}"
fi

DB_EXISTS=$(eval "${MYSQL_CMD} -e \"SHOW DATABASES LIKE '${LOCAL_DB}';\" 2>/dev/null" | grep -c "${LOCAL_DB}" || echo "0")

if [ "$DB_EXISTS" -eq 0 ]; then
    echo -e "${YELLOW}本地数据库不存在，正在创建...${NC}"
    eval "${MYSQL_CMD} -e \"CREATE DATABASE ${LOCAL_DB} CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;\" 2>/dev/null"
    echo -e "${GREEN}✓ 本地数据库已创建${NC}"
else
    echo -e "${YELLOW}警告: 本地数据库已存在${NC}"
    read -p "是否删除并重新创建? (yes/no): " confirm
    if [ "$confirm" = "yes" ]; then
        eval "${MYSQL_CMD} -e \"DROP DATABASE IF EXISTS ${LOCAL_DB};\" 2>/dev/null"
        eval "${MYSQL_CMD} -e \"CREATE DATABASE ${LOCAL_DB} CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;\" 2>/dev/null"
        echo -e "${GREEN}✓ 本地数据库已重新创建${NC}"
    else
        echo "操作已取消"
        exit 0
    fi
fi

# 同步数据
echo ""
echo -e "${YELLOW}正在同步数据（这可能需要几分钟）...${NC}"
if mysqldump -h ${REMOTE_HOST} \
             -P ${REMOTE_PORT} \
             -u ${REMOTE_USER} \
             -p${REMOTE_PASSWORD} \
             --single-transaction \
             --routines \
             --triggers \
             ${REMOTE_DB} | eval "${MYSQL_CMD} ${LOCAL_DB}" 2>/dev/null; then
    echo ""
    echo -e "${GREEN}========================================${NC}"
    echo -e "${GREEN}数据同步成功！${NC}"
    echo -e "${GREEN}========================================${NC}"
    echo ""
    echo "下一步："
    echo "  1. 配置后端 .env 文件（连接本地数据库）"
    echo "  2. 启动后端服务"
    echo "  3. 验证服务运行正常"
else
    echo ""
    echo -e "${RED}========================================${NC}"
    echo -e "${RED}数据同步失败！${NC}"
    echo -e "${RED}========================================${NC}"
    exit 1
fi
```

**使用方法：**
```bash
# 1. 创建脚本文件
nano sync_remote_database.sh

# 2. 粘贴上面的脚本内容，并修改配置信息

# 3. 添加执行权限
chmod +x sync_remote_database.sh

# 4. 执行脚本
./sync_remote_database.sh
```

## ⚠️ 注意事项

### 1. 网络连接

- ✅ 确保新服务器可以访问旧服务器的数据库端口（通常是 3306）
- ✅ 检查防火墙规则，确保端口开放
- ✅ 如果旧服务器有安全组（如云服务器），需要添加新服务器的 IP 到白名单

### 2. 数据库权限

- ✅ 确保旧服务器提供的数据库用户有 `SELECT` 权限（用于导出数据）
- ✅ 建议使用只读用户进行导出，更安全

### 3. 数据一致性

- ✅ 使用 `--single-transaction` 参数确保数据一致性
- ✅ 建议在业务低峰期进行同步
- ✅ 同步期间旧服务器仍可正常使用

### 4. 密码安全

- ⚠️ 不要在命令行中直接写密码（脚本中仅作示例）
- ✅ 使用交互式输入密码更安全：`mysql -u user -p`（不写密码）
- ✅ 或者使用 `.my.cnf` 配置文件存储密码

### 5. 数据量考虑

- 如果数据量很大（>10GB），建议：
  - 使用 `--compress` 参数压缩传输
  - 分批导出大表
  - 考虑使用 `rsync` 传输 SQL 文件

## 🔒 安全建议

### 1. 使用只读用户导出（推荐）

在旧服务器上创建只读用户用于导出：

```sql
-- 在旧服务器上执行
CREATE USER 'readonly_user'@'%' IDENTIFIED BY 'readonly_password';
GRANT SELECT ON gesp_practice_system.* TO 'readonly_user'@'%';
FLUSH PRIVILEGES;
```

然后使用这个只读用户进行导出。

### 2. 使用配置文件存储密码

创建 `~/.my.cnf` 文件：

```ini
[client]
host=106.14.143.27
port=3306
user=gesp_user
password=Gesp@2025!
```

设置文件权限：
```bash
chmod 600 ~/.my.cnf
```

然后可以直接使用：
```bash
mysqldump gesp_practice_system > dump.sql
```

### 3. 使用 SSH 隧道（更安全）

如果旧服务器不允许直接连接数据库端口，可以使用 SSH 隧道：

```bash
# 建立 SSH 隧道
ssh -L 3307:localhost:3306 user@old_server

# 在另一个终端，通过本地端口连接
mysqldump -h 127.0.0.1 -P 3307 -u gesp_user -p gesp_practice_system > dump.sql
```

## 📝 同步检查清单

同步完成后，请确认：

- [ ] 远程数据库连接测试通过
- [ ] 本地数据库已创建
- [ ] 数据已成功同步（表和数据都存在）
- [ ] 数据量检查通过（记录数量正确）
- [ ] `.env` 文件配置正确（连接本地数据库）
- [ ] 后端服务可以正常连接数据库
- [ ] 健康检查接口返回正常
- [ ] API 接口可以正常访问

## 🐛 常见问题

### 问题 1：无法连接远程数据库

**错误信息：** `Can't connect to MySQL server`

**解决方案：**
1. 检查网络连接：`ping <旧服务器IP>`
2. 检查端口是否开放：`telnet <旧服务器IP> 3306`
3. 检查旧服务器防火墙规则
4. 检查旧服务器 MySQL 是否允许远程连接

### 问题 2：权限不足

**错误信息：** `Access denied for user`

**解决方案：**
1. 确认用户名和密码正确
2. 检查用户是否有 SELECT 权限
3. 确认用户可以从新服务器 IP 连接

### 问题 3：同步速度慢

**解决方案：**
1. 使用 `--compress` 参数压缩传输
2. 在网络较好的时段同步
3. 如果数据量很大，考虑分批同步

### 问题 4：数据不一致

**解决方案：**
1. 确保使用 `--single-transaction` 参数
2. 在业务低峰期同步
3. 同步完成后验证数据完整性

## 📞 获取帮助

如果遇到问题，可以：

1. 查看 MySQL 错误日志：`/var/log/mysqld.log`
2. 查看同步脚本输出
3. 检查网络连接和防火墙规则
4. 查看项目文档：`README.md`

---

**最后更新：** 2025-01-20
**文档版本：** 1.0

