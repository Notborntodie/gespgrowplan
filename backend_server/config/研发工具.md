#### **相关环境**

如需添加小程序校验文件

| 相关事项    | 详细说明                                                     |
| ----------- | ------------------------------------------------------------ |
| T环境URL    | https://login-t.test.xdf.cn/sso/login?app_id=&redirect_uri=&response_type=&scope=&state=&switch_account=&ehr_org_id=&theme=&miniProgram_redirectUrl= |
| Q环境URL    | https://login-q.test.xdf.cn/sso/login?app_id=&redirect_uri=&response_type=&scope=&state=&switch_account=&ehr_org_id=&theme=&miniProgram_redirectUrl= |
| 正式环境URL | https://login.xdf.cn/sso/login?app_id=&redirect_uri=&response_type=&scope=&state=&switch_account=&ehr_org_id=&theme=&miniProgram_redirectUrl= |

#### 请求参数说明

| 参数                    | 是否必填 | 说明                                                         |
| ----------------------- | -------- | ------------------------------------------------------------ |
| app_id                  | Y        | 中台网关appId@史双龙 如果报"client_id或者app_id无效，请联系我们"，请联系马宁老师创建u2AppId。 |
| redirect_uri            | N        | 登录成功后跳转地址，域名需要同申请U2appId时配置的回调地址同域名不传递时跳转 [m.xdf.cn 或 www.xdf.cn](http://m.xdf.cn/www.xdf.cn) |
| response_type           | N        | 传code即可   response_type=code                              |
| scope                   | N        | 传login即可  scope=login                                     |
| state                   | N        | 接入方生成的一串字符串（推荐GUID/UUID），回调时会原值返回    |
| switch_account          | N        | true/false  是否是切换账号(参见微信退出登录和切换账号)，默认false |
| ehr_org_id              | Y        | 机构id，接入方从A2获取的机构标识 联系 [杨明武]() 获取，用于短信计费 |
| theme                   | N        | 主题颜色，目前支持5套主题颜色：default、blueGreen、yellowOrange、skyBlue、bluePurple |
| miniProgram_redirectUrl | N        | 仅限小程序对接H5时使用，小程序端指定登录成功后所跳转的页面，例如：miniProgram_redirectUrl=/pages/pay/pay 成功返回参数以url传参形式给出，指定页面 onLoad 生命周期 options 里面获取 eTokenps:  {eToken: "CtLyVHvvew5+R++pkQVGazGyCn+jItLNpyFxxdfj0styb/gWwJ6FOmQqAYQ+2VoE}eToken为u2at经过AES-CBC加密的数据，使用方后台可以通过AES-CBC解密，加解密逻辑：[[001-2\]AES-CBC加密算法说明](https://alidocs.dingtalk.com/i/nodes/MNDoBb60VLrO1jjNTj2Gw5yk8lemrZQ3) |
| wxAppId                 | N        | 微信appId 需 @范小龙1 (范小龙) 添加埋点域名配置小程序校验文件 |
| 自定义LOGO              | —        | 如果您需要显示自定义LOGO，请将制作好的LOGO私信给我们在后台进行配置![img](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/confluenceImport/-7021488112438488401/confluenceIMG/239830072/410419631.png) |
| isWxMiniProgram         | N        | 是否是微信小程序环境（true \| false）（注：PC 微信小程序判断UA不准确、此参数辅助判断跳转，其他场景请勿填写） |
| showLocale              | N        | ![img](https://alidocs.dingtalk.com/core/api/resources/img/5eecdaf48460cde5bf3d0b2162d089c937eebe6b09b760aa62e91324d09e6b32ee3d2764f5119f3e39e8703ac5556d0d5677432c7e837e5305b5e7e33b5458f6b8cccc9bdb2059a43d057ef2b86a30ae3a3e44b7fd18af6efbdebb9800ed8edc?tmpCode=12ca7e7a-9fb4-42c4-b870-0d4f8d711475)![img](https://alidocs.dingtalk.com/core/api/resources/img/5eecdaf48460cde5bf3d0b2162d089c937eebe6b09b760aa62e91324d09e6b32ee3d2764f5119f3e39e8703ac5556d0d099d44f7dad03dfb8d0f6679017b345dfe0c7e0c158491981c41711c9063021cef4988b2c5bd9f963c02c5ae4a5ac1f7?tmpCode=12ca7e7a-9fb4-42c4-b870-0d4f8d711475)![img](https://alidocs.dingtalk.com/core/api/resources/img/5eecdaf48460cde5bf3d0b2162d089c937eebe6b09b760aa62e91324d09e6b32ee3d2764f5119f3e39e8703ac5556d0dee62ca890dafd514e9714883817cb95c08956ba5fc8b572624bd975128e9fe62bfa031db0797a5ba86da74ac1ac5ba2a?tmpCode=12ca7e7a-9fb4-42c4-b870-0d4f8d711475)![img](https://alidocs.dingtalk.com/core/api/resources/img/5eecdaf48460cde5bf3d0b2162d089c937eebe6b09b760aa62e91324d09e6b32ee3d2764f5119f3e39e8703ac5556d0db240677c8f454374f7ae53d1b8b80bbcc7ce692d14f6fac06c89c1bc2c867724338a5dab0eff9131a4a40c926bec9023?tmpCode=12ca7e7a-9fb4-42c4-b870-0d4f8d711475)是否展示国际区服 默认不展示 showLocale = 1 时展示 |





#### **#3 登录成功后的cookie数据**

| cookie     | 说明                                                         |
| ---------- | ------------------------------------------------------------ |
| U2AT       | 存放tokenId，提供对接方根据此信息调用token验证接口，验证是否在线 重要：新对接请使用U2AT验证登录状态以及获取userId等信息 |
| U2Token    | 存放u2token信息，内部使用重要：此信息为兼容旧逻辑，新对接请使用U2AT验证登录状态以及获取userId等信息 |
| U2NickName | urlencode后的用户名昵称 重要：此信息为兼容旧逻辑，新对接请使用U2AT验证登录状态以及获取userId等信息 |
| U2User     | 经过AESouterKey加密登录名后再urlencode 重要：此信息为兼容旧逻辑，新对接请使用U2AT验证登录状态以及获取userId等信息 |
| U2UserId   | 经过AES-ECB模式加密userid后再urlencode解密规则：先urldecode,再通过AES-ECB模式解密重要：此信息为兼容旧逻辑，新对接请使用U2AT验证登录状态以及获取userId等信息:[[002\]验证tokenApi](https://alidocs.dingtalk.com/i/nodes/gvNG4YZ7JneM4yy1tDxO5PDmV2LD0oRE) |

#### #4 接入要点

1、接入方在本系统内部判断，如果未登录，则跳转登录页；

2、登录成功后写入cookie,并回调到接入方系统提供的回调地址；

3、安全组要求使用https

4、pc端和H5端会分别根据设备跳转相应的地址，即在pc端访问H5地址，会自动跳转到H5的地址，反之亦然

5、登录成功后，后续验证登录状态可以使用cookie中获取的U2AT即accesstoken调用 **Tokenapi（**[TokenAPI列表](http://confluence.staff.xdf.cn/pages/viewpage.action?pageId=285737002)**）**验证是否在线，同时换取userid；

## **重要提醒：相关key与secret 绝对不能放在前端，只能放在服务后端，防止泄密**



### 五、退出登录

------

方法一(推荐)

用页面跳转方式退出，跳转到响应环境的退出页面，它会自动删除cookie并跳转回配置的目标页

T环境 ：[https://login-t.test.xdf.cn/logout.html?app_id=](https://login.xdf.cn/logout.html?redirect_uri=http%3A%2F%2Fi.xdf.cn&app_id=test)xxx&[redirect_uri=](https://login.xdf.cn/logout.html?redirect_uri=http%3A%2F%2Fi.xdf.cn&app_id=test)退出后的目标页（需要标准格式，即需要以https/http开头）

Q环境：[https://login-q.test.xdf.cn/logout.html?app_id=x](https://login.xdf.cn/logout.html?redirect_uri=http%3A%2F%2Fi.xdf.cn&app_id=test)xx&[redirect_uri=](https://login.xdf.cn/logout.html?redirect_uri=http%3A%2F%2Fi.xdf.cn&app_id=test)退出后的目标页（需要标准格式，即需要以https/http开头）

线上环境：[https://login.xdf.cn/logout.html?app_id=x](https://login.xdf.cn/logout.html?redirect_uri=http%3A%2F%2Fi.xdf.cn&app_id=test)xx&[redirect_uri=](https://login.xdf.cn/logout.html?redirect_uri=http%3A%2F%2Fi.xdf.cn&app_id=test)退出后的目标页（需要标准格式，即需要以https/http开头）

方法二

退出时自行直接删除[xdf.cn](http://xdf.cn/)域如上cookie即可；缺点：未来如果有变动需要修改



### 六、H5登录弹窗SDK接入

------

#### #1 引入SDK文件

https://g.xdfstatic.cn/w/u2LoginSDK/0.0.1/U2Login.umd.min.js

```
// 静态引入
script type="text/javascript" src="https://g.xdfstatic.cn/w/u2LoginSDK/0.0.1/U2Login.umd.min.js"
 
// 动态引入，仅供参考
try {
    const script = document.createElement('script')
    script.setAttribute('type', 'text/javascript')
    script.setAttribute('src', 'https://g.xdfstatic.cn/w/u2LoginSDK/0.0.1/U2Login.umd.min.js')
    document.body.appendChild(script)
} catch (e) {
    console.log('引入sdk文件失败')               
}
```

####  #2 请求参数说明

| 参数         | 是否必填 | 说明                                                         |
| ------------ | -------- | ------------------------------------------------------------ |
| app_id       | Y        | 网关appId                                                    |
| ehr_org_id   | Y        | 机构id，接入方从A2获取的机构标识 联系 [杨明武]()获取，用于短信计费 |
| redirect_uri | N        | 接入方域名，域名需要同申请U2AppId时配置的回调地址同域名      |
| maskable     | N        | 默认值true，是否展示蒙层，默认展示                           |
| maskClosable | N        | 默认值false，表示点击蒙层不关闭弹框。如需点击蒙层关闭，请设置为true即可 |
| theme        | N        | 主题，请联系@崔钰11 (崔钰)进行配置，目前支持`yellowOrange`, `blueGreen`两种 |
| zIndex       | N        | 弹窗层级，默认9999                                           |
| isTest       | N        | 是否是测试环境，默认false，只有传递 isTest: true 时，才会请求测试环境。 |

#### #3 使用方式

注意：需要在引入sdk后使用

```
try {
    if（window.U2Login）{
        window.U2Login.init(
            {
                isTest: '是否是测试环境',
                app_id: '网关appId',
                redirect_uri: '接入方域名',
                theme: '主题',
                ehr_org_id: '机构id',
                maskClosable: true
            },
            (obj) => {
                console.log('登录成功回调参数', obj)
                window.U2Login.close() // 关闭登录弹窗
            }
        )
    }
} catch (e) {}
```