# 练习系统后端 - 项目架构文档

## 目录
- [1. 项目概述](#1-项目概述)
- [2. 系统架构](#2-系统架构)
- [3. 技术栈](#3-技术栈)
- [4. 目录结构](#4-目录结构)
- [5. 核心模块说明](#5-核心模块说明)
- [6. 中间件系统](#6-中间件系统)
- [7. 服务层架构](#7-服务层架构)
- [8. 数据库设计](#8-数据库设计)
- [9. API路由设计](#9-api路由设计)
- [10. 配置管理](#10-配置管理)
- [11. 安全机制](#11-安全机制)
- [12. 性能优化](#12-性能优化)
- [13. 部署与运维](#13-部署与运维)
- [14. 开发指南](#14-开发指南)

---

## 1. 项目概述

### 1.1 项目简介

GESP练习系统后端是一个基于 Node.js 和 Express 框架构建的在线判题系统（OJ - Online Judge），主要为 GESP（全国青少年编程能力等级考试）提供练习和考试功能。系统支持客观题练习、在线编程判题、学习计划管理、知识体系管理等功能。

### 1.2 核心功能

- **用户认证与授权**：用户注册、登录、JWT token认证、基于角色的权限控制（RBAC）
- **客观题系统**：考试管理、题目管理、答题记录、成绩统计
- **在线判题系统（OJ）**：代码提交、自动判题、测试用例管理、提交历史
- **学习计划系统**：学习计划创建、任务分配、进度跟踪、任务完成统计
- **知识点管理**：知识点分类、题目关联、统计分析
- **教师功能**：学生管理、成绩查询、学习进度监控
- **统计分析**：答题统计、错题分析、知识点掌握情况分析

### 1.3 技术特点

- **高性能**：使用连接池、Redis缓存、消息队列等技术优化性能
- **高并发**：支持多实例部署、负载均衡、异步任务处理
- **安全性**：SQL注入防护、XSS防护、请求限流、JWT认证
- **可扩展性**：模块化设计、服务分离、支持水平扩展
- **可维护性**：完善的日志系统、错误处理、健康检查

---

## 2. 系统架构

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                      客户端层 (Client)                        │
│                  Web前端 / 移动端 / API调用                    │
└───────────────────────┬─────────────────────────────────────┘
                        │ HTTP/HTTPS
                        ▼
┌─────────────────────────────────────────────────────────────┐
│                    Express应用层 (Application)                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │   路由层     │  │   中间件层    │  │   认证层     │      │
│  │  (Routes)    │  │ (Middleware)  │  │   (Auth)     │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└───────────────────────┬─────────────────────────────────────┘
                        │
        ┌───────────────┼───────────────┐
        ▼               ▼               ▼
┌──────────────┐ ┌──────────────┐ ┌──────────────┐
│   服务层     │ │   缓存层     │ │   队列层     │
│  (Services)  │ │   (Redis)    │ │   (Bull)     │
└──────┬───────┘ └──────────────┘ └──────┬───────┘
       │                                  │
       ▼                                  ▼
┌─────────────────────────────────────────────────────────────┐
│                    数据持久层 (Data Layer)                    │
│  ┌──────────────┐              ┌──────────────┐            │
│  │   MySQL      │              │   Redis      │            │
│  │  (主数据库)   │              │  (缓存/队列)  │            │
│  └──────────────┘              └──────────────┘            │
└─────────────────────────────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│                  外部服务层 (External Services)               │
│  ┌──────────────┐                                          │
│  │   isolate    │  - 代码隔离执行沙箱                       │
│  │   (沙箱)     │  - 支持C++等语言的代码执行                 │
│  └──────────────┘                                          │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 请求处理流程

```
1. 客户端请求
   ↓
2. 安全中间件（Helmet、CORS、XSS防护等）
   ↓
3. 限流中间件（Rate Limiting）
   ↓
4. 认证中间件（JWT验证）
   ↓
5. 缓存中间件（Redis缓存查询）
   ↓
6. 路由处理（业务逻辑）
   ↓
7. 服务层调用（数据库操作、业务处理）
   ↓
8. 响应返回（带缓存）
```

### 2.3 判题流程架构

```
用户提交代码
   ↓
1. 创建提交记录（状态：queued）
   ↓
2. 添加到判题队列（Bull Queue）
   ↓
3. 队列处理器（Worker）
   ├─ 获取题目信息和测试样例
   ├─ 编译代码
   ├─ 使用 isolate 沙箱执行测试
   └─ 保存判题结果
   ↓
4. 更新提交记录（状态：completed/error）
   ↓
5. 更新题目统计信息（异步）
   ↓
6. 通知用户（WebSocket/轮询）
```

---

## 3. 技术栈

### 3.1 核心框架

| 技术 | 版本 | 用途 |
|------|------|------|
| Node.js | >= 14.0.0 | 运行环境 |
| Express | ^4.18.2 | Web框架 |
| MySQL2 | ^3.14.3 | 数据库驱动 |

### 3.2 中间件与工具

| 技术 | 版本 | 用途 |
|------|------|------|
| body-parser | ^1.20.2 | 请求体解析 |
| cors | ^2.8.5 | 跨域资源共享 |
| helmet | ^7.1.0 | 安全头设置 |
| compression | ^1.7.4 | 响应压缩 |
| multer | ^2.0.2 | 文件上传 |
| express-rate-limit | ^7.1.5 | 请求限流 |

### 3.3 认证与安全

| 技术 | 版本 | 用途 |
|------|------|------|
| jsonwebtoken | ^9.0.2 | JWT认证 |
| bcryptjs | ^2.4.3 | 密码加密 |
| joi | ^17.11.0 | 数据验证 |

### 3.4 缓存与队列

| 技术 | 版本 | 用途 |
|------|------|------|
| ioredis | ^5.3.2 | Redis客户端 |
| redis | ^4.6.0 | Redis备用客户端 |
| bull | ^4.16.5 | 任务队列 |

### 3.5 日志与监控

| 技术 | 版本 | 用途 |
|------|------|------|
| winston | ^3.11.0 | 日志记录 |
| pm2 | ^5.3.0 | 进程管理 |

### 3.6 其他工具

| 技术 | 版本 | 用途 |
|------|------|------|
| dotenv | ^16.3.1 | 环境变量管理 |
| axios | ^1.11.0 | HTTP客户端 |
| xml2js | ^0.6.2 | XML解析 |

### 3.7 外部依赖

| 技术 | 说明 | 用途 |
|------|------|------|
| MySQL | >= 5.7 | 关系型数据库 |
| Redis | >= 5.0 | 缓存和消息队列 |
| isolate | 最新版 | 代码隔离执行沙箱 |

---

## 4. 目录结构

```
backend_server/
├── app.js                    # Express应用主文件（中间件注册、路由挂载）
├── server.js                 # 服务器启动入口（端口监听、优雅关闭）
├── package.json              # 项目依赖配置
├── ecosystem.config.js       # PM2进程管理配置
├── .env                      # 环境变量配置（不提交到git）
├── env.example               # 环境变量示例文件
│
├── config/                   # 配置文件目录
│   ├── database.js          # MySQL连接池配置
│   ├── cache.js             # Redis缓存配置与工具
│   └── logger.js            # Winston日志配置
│
├── middleware/              # 中间件目录
│   ├── security.js         # 安全中间件（Helmet、CORS、XSS防护等）
│   └── rateLimit.js        # 限流中间件（基于Redis）
│
├── routes/                  # 路由目录
│   ├── index.js            # 路由入口（注册所有路由）
│   ├── auth.js             # 认证路由（登录、注册）
│   ├── users.js            # 用户管理路由
│   ├── teachers.js         # 教师功能路由
│   ├── questions.js        # 题目管理路由
│   ├── exams.js            # 考试管理路由
│   ├── submissions.js      # 答题记录路由
│   ├── knowledge.js        # 知识点管理路由
│   ├── oj.js               # 在线判题路由
│   └── learningPlans.js    # 学习计划路由
│
├── services/                # 服务层目录
│   ├── judgeQueue.js       # 判题队列服务（Bull队列管理）
│   ├── isolateJudge.js     # 代码判题服务（isolate沙箱执行）
│   └── containerPool.js    # 容器池管理（已弃用，改用isolate）
│
├── database/                # 数据库相关
│   ├── *.sql               # 数据库备份/初始化SQL文件
│   ├── import_database.sh  # 数据库导入脚本
│   └── 数据库.md           # 数据库设计文档
│
├── scripts/                 # 工具脚本目录
│   ├── init_oj_database.js # OJ数据库初始化
│   ├── init_learning_plan_database.js # 学习计划数据库初始化
│   └── ...                 # 其他工具脚本
│
├── logs/                    # 日志目录
│   ├── combined.log        # 所有日志
│   ├── error.log           # 错误日志
│   └── access.log          # 访问日志
│
├── uploads/                 # 上传文件目录
│   └── image-*.png         # 用户上传的图片
│
├── oj_data/                 # OJ题目数据目录
│   └── gesp/               # GESP题目数据
│
├── isolate-master/          # isolate沙箱源码
│   ├── isolate             # 可执行文件
│   └── ...                 # 源码文件
│
├── test/                    # 测试目录
│   ├── test_api.js         # API测试脚本
│   └── ...                 # 其他测试文件
│
├── docs/                    # 文档目录
│   ├── 数据库.md           # 数据库设计文档
│   ├── 任务进度相关接口说明.md # 接口文档
│   └── 项目架构文档.md     # 本文档
│
└── README.md                # 项目说明文档
```

---

## 5. 核心模块说明

### 5.1 应用入口 (`app.js`)

**功能**：
- Express应用初始化
- 中间件注册（安全、压缩、CORS、限流、性能监控等）
- 路由挂载
- 错误处理中间件
- 静态文件服务
- 健康检查接口

**关键代码结构**：
```javascript
// 基础中间件
app.use(bodyParser.json({ limit: '10mb' }));
app.use(bodyParser.urlencoded({ extended: true, limit: '10mb' }));

// 安全中间件
app.use(securityMiddleware.helmet);
app.use(securityMiddleware.compression);
app.use(securityMiddleware.cors);
app.use(securityMiddleware.xssProtection);

// 性能监控
app.use(performanceMonitor);

// 路由注册
app.use('/', routes);

// 错误处理
app.use(errorLogger);
app.use((err, req, res, next) => { /* 全局错误处理 */ });
```

### 5.2 服务器启动 (`server.js`)

**功能**：
- 加载环境变量（dotenv）
- 启动HTTP服务器
- 优雅关闭处理（SIGTERM、SIGINT）
- 未捕获异常处理
- 超时配置

**关键特性**：
- 支持优雅关闭（等待请求完成后再关闭）
- 完善的异常捕获机制
- 服务器超时配置（30秒请求超时）

### 5.3 数据库配置 (`config/database.js`)

**功能**：
- MySQL连接池创建与管理
- 连接池配置优化
- 连接池事件监听
- 健康检查机制
- 优雅关闭处理

**连接池配置**：
```javascript
{
  connectionLimit: 20,        // 最大连接数
  acquireTimeout: 60000,      // 获取连接超时
  timeout: 60000,             // 查询超时
  reconnect: true,            // 自动重连
  enableKeepAlive: true,      // 连接保活
  maxIdle: 60000,             // 最大空闲时间
  idleTimeout: 60000          // 空闲超时
}
```

**特性**：
- 支持从环境变量读取配置
- 定期健康检查（每5分钟）
- 连接池事件日志记录
- 自动重连机制

### 5.4 缓存配置 (`config/cache.js`)

**功能**：
- Redis客户端创建与管理
- 缓存中间件实现
- 缓存工具函数（set、get、del等）
- 专用缓存管理（知识点、OJ题目）

**缓存策略**：
- **通用缓存**：自动缓存GET请求响应（默认5分钟）
- **知识点缓存**：分类、级别缓存（10分钟）
- **OJ题目缓存**：题目信息、测试样例缓存（30分钟）

**工具函数**：
```javascript
cacheUtils.set(key, value, duration)      // 设置缓存
cacheUtils.get(key)                       // 获取缓存
cacheUtils.del(key)                       // 删除缓存
cacheUtils.delPattern(pattern)            // 批量删除
cacheUtils.knowledge.clearAll()           // 清除知识点缓存
cacheUtils.oj.clearProblem(problemId)     // 清除题目缓存
```

### 5.5 日志配置 (`config/logger.js`)

**功能**：
- Winston日志记录器配置
- 多级别日志输出（error、warn、info、debug）
- 日志文件轮转（5MB/文件，保留5个文件）
- 性能监控中间件
- 错误日志中间件
- 数据库查询日志
- 缓存操作日志

**日志分类**：
- `error.log`：错误日志
- `combined.log`：所有日志
- `access.log`：访问日志
- 控制台输出（开发环境）

**性能监控**：
- 请求开始/结束时间记录
- 慢请求警告（>1秒）
- 慢查询警告（>100ms）

---

## 6. 中间件系统

### 6.1 安全中间件 (`middleware/security.js`)

#### 6.1.1 Helmet 安全头

**功能**：设置HTTP安全响应头，防止常见网络攻击

**配置**：
- Content-Security-Policy：内容安全策略
- Cross-Origin-Resource-Policy：跨域资源策略
- 禁用嵌入式对象、框架等

#### 6.1.2 CORS 跨域配置

**功能**：允许跨域请求，支持前端调用

**配置**：
```javascript
Access-Control-Allow-Origin: *
Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS
Access-Control-Allow-Headers: Origin, X-Requested-With, Content-Type, Accept, Authorization
Access-Control-Allow-Credentials: true
```

#### 6.1.3 请求大小限制

**功能**：限制请求体大小，防止DoS攻击

**限制**：最大10MB

#### 6.1.4 SQL注入防护

**功能**：检测和阻止SQL注入攻击

**实现**：正则表达式检测常见的SQL关键字

**注意**：当前已注释，主要依靠参数化查询防护

#### 6.1.5 XSS防护

**功能**：清理请求中的恶意脚本

**实现**：过滤 `<script>` 标签

#### 6.1.6 User-Agent检查

**功能**：检测可疑的User-Agent（爬虫、bot等）

**实现**：正则表达式匹配常见爬虫标识

#### 6.1.7 请求来源验证

**功能**：验证请求的Origin头

**实现**：白名单机制（可配置允许的来源）

### 6.2 限流中间件 (`middleware/rateLimit.js`)

**功能**：基于Redis的请求限流，防止API滥用

**限流策略**：

| 接口类型 | 时间窗口 | 最大请求数 | 说明 |
|---------|---------|-----------|------|
| 认证接口 | 15分钟 | 5次 | 登录、注册 |
| 注册接口 | 1小时 | 3次 | 防止批量注册 |
| 文件上传 | 1分钟 | 10次 | 图片上传 |
| 题目上传 | 1分钟 | 10次 | 题目创建 |
| 批量上传 | 1分钟 | 3次 | 批量题目上传 |
| 一般API | 1分钟 | 100次 | 普通接口 |
| 考试接口 | 1分钟 | 30次 | 考试相关 |
| 查询接口 | 1分钟 | 200次 | 查询接口 |

**特性**：
- 基于IP和用户ID的键生成
- Redis存储限流计数
- 支持动态限流（根据用户角色调整）
- 白名单支持

**实现**：
```javascript
const limiter = rateLimit({
  windowMs: 60000,      // 时间窗口（毫秒）
  max: 100,             // 最大请求数
  store: {              // Redis存储
    incr: async (key) => { /* Redis递增 */ },
    decrement: async (key) => { /* Redis递减 */ },
    resetKey: async (key) => { /* Redis删除 */ }
  }
});
```

### 6.3 性能监控中间件

**位置**：`config/logger.js`

**功能**：
- 记录请求开始时间
- 记录请求结束时间和耗时
- 记录慢请求（>1秒）
- 记录请求详情（方法、URL、IP、User-Agent）

**实现**：重写 `res.json` 和 `res.send` 方法，在响应时记录性能数据

### 6.4 缓存中间件

**位置**：`config/cache.js`

**功能**：
- 自动缓存GET请求响应
- 可配置缓存时间
- 支持缓存键前缀

**使用**：
```javascript
router.get('/api/exams', cacheMiddleware(300, 'exams'), handler);
// 缓存5分钟，键前缀为 'exams'
```

---

## 7. 服务层架构

### 7.1 判题队列服务 (`services/judgeQueue.js`)

**技术**：Bull（基于Redis的队列）

**功能**：
- 判题任务入队
- 判题任务处理（并发数为3）
- 队列状态监控
- 任务重试机制

**队列配置**：
```javascript
{
  attempts: 2,              // 失败后重试2次
  backoff: {
    type: 'exponential',    // 指数退避
    delay: 2000             // 初始延迟2秒
  },
  removeOnComplete: 100,    // 保留最近100个完成的任务
  removeOnFail: 200         // 保留最近200个失败的任务
}
```

**处理流程**：
1. 获取题目信息和测试样例（使用缓存）
2. 调用 `isolateJudge` 服务进行判题
3. 更新提交记录状态
4. 异步更新题目统计信息

**优化**：
- 减少数据库操作（直接更新最终状态，不更新中间状态）
- 使用缓存获取题目信息
- 异步更新统计信息（不阻塞响应）

### 7.2 代码判题服务 (`services/isolateJudge.js`)

**技术**：isolate 沙箱（IOI官方使用的隔离执行环境）

**优势**：
- 启动速度快（10-50ms，比Docker快10-20倍）
- 内存占用小（~10MB，比Docker少20倍）
- 安全性高（Linux namespace + cgroup）
- 资源限制精确（时间、内存、进程数等）

**功能**：
- 代码编译（支持C++）
- 代码执行（isolate沙箱）
- 测试用例验证
- 结果判定

**沙箱池管理**：
- 复用isolate box（减少初始化开销）
- 池大小：10个box
- 自动初始化和清理

**执行流程**：
1. 从池中获取isolate box
2. 编译代码（g++）
3. 复制二进制文件到box
4. 写入测试输入
5. 使用isolate执行程序
6. 读取输出和元数据
7. 比较输出与期望结果
8. 清理box并释放

**资源限制**：
- 时间限制：根据题目配置（默认1000ms）
- 内存限制：根据题目配置（默认256MB）
- 进程数限制：20个
- 文件大小限制：10MB

**判题结果**：
- `Accepted`：通过所有测试用例
- `Wrong Answer`：输出错误
- `Time Limit Exceeded`：超时
- `Memory Limit Exceeded`：内存超限
- `Runtime Error`：运行时错误
- `Compilation Error`：编译错误

### 7.3 容器池服务 (`services/containerPool.js`)

**状态**：已弃用，改用isolate方案

**说明**：原计划使用Docker容器池，但isolate方案性能更优，已切换

---

## 8. 数据库设计

### 8.1 数据库概述

**数据库类型**：MySQL 5.7+

**字符集**：utf8mb4

**命名规范**：
- 表名：小写字母+下划线（snake_case）
- 字段名：小写字母+下划线
- 主键：`id`（自增整数）
- 外键：`{表名}_id`（如 `user_id`、`exam_id`）

### 8.2 核心表结构

详细数据库设计请参考 `docs/数据库.md` 文档。以下是核心表概述：

#### 8.2.1 用户相关表

- **users**：用户基本信息
- **roles**：角色定义
- **permissions**：权限定义
- **user_roles**：用户角色关联
- **role_permissions**：角色权限关联
- **teacher_students**：师生关系

#### 8.2.2 客观题系统表

- **exams**：考试信息
- **questions**：题目信息
- **options**：题目选项
- **exam_questions**：考试题目关联
- **submissions**：答题记录
- **submission_answers**：答题详情

#### 8.2.3 OJ系统表

- **oj_problems**：OJ题目信息
- **oj_samples**：测试样例
- **oj_submissions**：代码提交记录

#### 8.2.4 学习计划系统表

- **learning_plans**：学习计划
- **learning_tasks**：学习任务
- **task_exams**：任务-考试关联
- **task_oj_problems**：任务-OJ题目关联
- **user_learning_plans**：用户加入的计划
- **user_task_progress**：用户任务完成进度
- **user_exam_progress**：用户考试练习进度
- **user_oj_progress**：用户OJ题目练习进度
- **user_plan_progress**：用户计划完成进度

#### 8.2.5 知识点系统表

- **knowledge_points**：知识点定义
- **question_knowledge_points**：题目-知识点关联

#### 8.2.6 其他表

- **question_uploads**：题目上传记录
- **question_images**：题目图片
- **user_wrong_questions**：用户错题记录

### 8.3 数据库连接池

**配置位置**：`config/database.js`

**关键配置**：
- 连接池大小：20（可配置）
- 获取连接超时：60秒
- 查询超时：60秒
- 自动重连：启用
- 连接保活：启用

**优化建议**：
- 根据服务器性能和并发需求调整连接池大小
- 监控连接池使用情况
- 定期检查慢查询

---

## 9. API路由设计

### 9.1 路由组织

所有路由都挂载在 `/api` 路径下，通过 `routes/index.js` 统一管理。

### 9.2 路由列表

#### 9.2.1 认证路由 (`/api/auth`)

- `POST /api/register` - 用户注册
- `POST /api/login` - 用户登录
- `POST /api/logout` - 用户登出（可选）

#### 9.2.2 用户路由 (`/api/users`)

- `GET /api/users` - 获取用户列表
- `GET /api/users/:id` - 获取用户详情
- `PUT /api/users/:id` - 更新用户信息
- `DELETE /api/users/:id` - 删除用户

#### 9.2.3 考试路由 (`/api/exams`)

- `GET /api/exams` - 获取考试列表（支持过滤）
- `GET /api/exams/:examId` - 获取考试详情
- `POST /api/exams` - 创建考试
- `PUT /api/exams/:examId` - 更新考试
- `DELETE /api/exams/:examId` - 删除考试
- `POST /api/exams/:examId/submit` - 提交答案

#### 9.2.4 题目路由 (`/api/questions`)

- `GET /api/questions` - 获取题目列表
- `GET /api/questions/:id` - 获取题目详情
- `POST /api/questions` - 创建题目
- `PUT /api/questions/:id` - 更新题目
- `DELETE /api/questions/:id` - 删除题目
- `POST /api/questions/batch` - 批量上传题目

#### 9.2.5 OJ路由 (`/api/oj`)

- `GET /api/oj/problems` - 获取OJ题目列表
- `GET /api/oj/problems/:problemId` - 获取OJ题目详情
- `POST /api/oj/problems` - 创建OJ题目
- `POST /api/oj/submit` - 提交代码判题
- `GET /api/oj/submissions` - 获取提交记录
- `GET /api/oj/submissions/:submissionId` - 获取提交详情

#### 9.2.6 学习计划路由 (`/api/learning-plans`)

- `GET /api/learning-plans` - 获取学习计划列表
- `GET /api/learning-plans/:planId` - 获取学习计划详情
- `POST /api/learning-plans` - 创建学习计划
- `PUT /api/learning-plans/:planId` - 更新学习计划
- `POST /api/learning-plans/:planId/tasks` - 添加任务
- `GET /api/learning-plans/:planId/progress` - 获取进度

#### 9.2.7 知识点路由 (`/api/knowledge`)

- `GET /api/knowledge` - 获取知识点列表
- `GET /api/knowledge/:id` - 获取知识点详情
- `POST /api/knowledge` - 创建知识点

#### 9.2.8 其他路由

- `GET /api/submissions` - 获取答题记录
- `GET /api/submissions/:id` - 获取答题详情
- `GET /health` - 健康检查

### 9.3 认证机制

**JWT Token认证**：
- Token存储在请求头的 `Authorization` 字段
- 格式：`Bearer {token}`
- Token包含用户ID、角色等信息
- Token过期时间可配置

**路由保护**：
```javascript
const authenticate = require('../middleware/authenticate');
router.get('/api/users/:id', authenticate, handler);
```

---

## 10. 配置管理

### 10.1 环境变量配置

项目使用 `dotenv` 包管理环境变量，配置存储在 `.env` 文件中。

**配置项**：

```env
# 应用配置
NODE_ENV=production
PORT=3000

# 数据库配置
DB_HOST=106.14.143.27
DB_PORT=3306
DB_NAME=gesp_practice_system
DB_USER=gesp_user
DB_PASSWORD=Gesp@2025!
DB_CONNECTION_LIMIT=20
DB_ACQUIRE_TIMEOUT=60000
DB_TIMEOUT=60000
DB_MAX_IDLE=60000
DB_IDLE_TIMEOUT=60000

# Redis配置
REDIS_HOST=106.14.143.27
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DB=0
REDIS_MAX_RETRIES=3
REDIS_RETRY_DELAY=100
REDIS_CONNECT_TIMEOUT=10000
REDIS_COMMAND_TIMEOUT=5000

# 文件上传配置
UPLOAD_PATH=./uploads
MAX_FILE_SIZE=10485760
```

### 10.2 配置加载顺序

1. 环境变量（`process.env`）
2. `.env` 文件（通过dotenv加载）
3. 代码默认值

### 10.3 PM2配置

**配置文件**：`ecosystem.config.js`

**关键配置**：
- 应用名称：`gesp-api`
- 启动脚本：`./server.js`
- 实例数：`max`（使用所有CPU核心）
- 执行模式：`cluster`（集群模式）
- 自动重启：启用
- 内存限制：1GB

---

## 11. 安全机制

### 11.1 认证与授权

**JWT认证**：
- Token签名算法：HS256
- Token包含用户ID、角色等信息
- Token过期时间可配置

**RBAC权限控制**：
- 基于角色的访问控制
- 角色：管理员、教师、学生等
- 权限：细粒度的资源操作权限

### 11.2 数据安全

**密码加密**：
- 使用 bcryptjs 加密密码
- 盐值自动生成
- 加密轮数：10

**SQL注入防护**：
- 使用参数化查询（Prepared Statements）
- 避免字符串拼接SQL

**XSS防护**：
- 请求数据清理（过滤script标签）
- 响应头设置（Content-Security-Policy）

### 11.3 请求安全

**请求限流**：
- 基于Redis的限流
- 不同接口不同限流策略
- IP和用户ID双重限流

**请求验证**：
- User-Agent检查
- Origin验证
- 请求大小限制（10MB）

**HTTPS支持**：
- 建议生产环境使用HTTPS
- 配置SSL证书

### 11.4 文件安全

**文件上传限制**：
- 文件大小限制：10MB
- 文件类型验证（图片等）
- 文件存储路径隔离

---

## 12. 性能优化

### 12.1 数据库优化

**连接池优化**：
- 连接池大小：20（根据实际情况调整）
- 连接复用
- 连接保活

**查询优化**：
- 使用索引
- 避免全表扫描
- 分页查询
- 使用EXPLAIN分析慢查询

**缓存策略**：
- 热点数据缓存（Redis）
- 查询结果缓存（5-30分钟）
- 缓存失效策略

### 12.2 缓存优化

**Redis缓存**：
- 缓存热点数据（题目信息、测试样例等）
- 缓存查询结果
- 缓存键命名规范
- 缓存失效管理

**缓存层次**：
1. 内存缓存（应用层）
2. Redis缓存（分布式）
3. 数据库（持久层）

### 12.3 并发优化

**异步处理**：
- 判题任务异步处理（Bull队列）
- 统计信息异步更新
- 非关键操作异步执行

**负载均衡**：
- PM2集群模式（多进程）
- 使用所有CPU核心
- 请求分发

### 12.4 判题优化

**isolate沙箱**：
- 轻量级隔离执行（比Docker快10-20倍）
- 沙箱池复用
- 并发数控制（3个并发）

**代码优化**：
- 减少数据库操作
- 批量处理测试用例
- 异步更新统计信息

---

## 13. 部署与运维

### 13.1 部署环境要求

- **操作系统**：Linux（CentOS 7+/Ubuntu 18+）
- **Node.js**：>= 14.0.0
- **MySQL**：>= 5.7
- **Redis**：>= 5.0
- **PM2**：>= 5.0（进程管理）
- **isolate**：已安装并配置

### 13.2 部署步骤

1. **安装依赖**
   ```bash
   npm install
   ```

2. **配置环境变量**
   ```bash
   cp env.example .env
   # 编辑 .env 文件，配置数据库、Redis等信息
   ```

3. **初始化数据库**
   ```bash
   mysql -u root -p < database/*.sql
   ```

4. **安装isolate**
   ```bash
   cd isolate-master
   make isolate
   sudo make install
   sudo isolate --init
   ```

5. **启动服务**
   ```bash
   npm run pm2:start
   # 或
   pm2 start ecosystem.config.js --env production
   ```

6. **设置开机自启**
   ```bash
   pm2 save
   pm2 startup
   ```

### 13.3 监控与日志

**日志位置**：
- 应用日志：`logs/combined.log`
- 错误日志：`logs/error.log`
- 访问日志：`logs/access.log`
- PM2日志：`pm2 logs gesp-api`

**监控指标**：
- 请求数量
- 响应时间
- 错误率
- 队列长度
- 数据库连接数
- 内存使用

**健康检查**：
```bash
curl http://localhost:3000/health
```

### 13.4 备份与恢复

**数据库备份**：
```bash
mysqldump -u gesp_user -p gesp_practice_system > backup.sql
```

**文件备份**：
```bash
tar -czf uploads_backup.tar.gz uploads/
```

**恢复**：
```bash
mysql -u gesp_user -p gesp_practice_system < backup.sql
tar -xzf uploads_backup.tar.gz
```

---

## 14. 开发指南

### 14.1 开发环境设置

1. **克隆项目**
   ```bash
   git clone <repository-url>
   cd backend_server
   ```

2. **安装依赖**
   ```bash
   npm install
   ```

3. **配置环境变量**
   ```bash
   cp env.example .env
   # 修改 .env 文件，使用本地数据库配置
   ```

4. **启动开发服务器**
   ```bash
   npm run dev  # 使用nodemon，自动重启
   ```

### 14.2 代码规范

**命名规范**：
- 变量/函数：驼峰命名（camelCase）
- 常量：大写+下划线（UPPER_SNAKE_CASE）
- 类名：帕斯卡命名（PascalCase）
- 文件名：小写+下划线（snake_case）

**代码风格**：
- 使用2空格缩进
- 使用单引号
- 语句末尾加分号
- 函数和类之间空行

### 14.3 添加新功能

1. **添加路由**
   - 在 `routes/` 目录创建新路由文件
   - 在 `routes/index.js` 注册路由

2. **添加服务**
   - 在 `services/` 目录创建服务文件
   - 在路由中调用服务

3. **添加中间件**
   - 在 `middleware/` 目录创建中间件文件
   - 在 `app.js` 中注册中间件

### 14.4 测试

**API测试**：
```bash
node test/test_api.js
```

**手动测试**：
- 使用Postman、curl等工具
- 查看日志文件

### 14.5 常见问题

**问题1：数据库连接失败**
- 检查数据库服务是否运行
- 检查 `.env` 文件配置
- 检查防火墙设置

**问题2：Redis连接失败**
- 检查Redis服务是否运行：`redis-cli ping`
- 检查Redis配置

**问题3：isolate执行失败**
- 检查isolate是否安装：`isolate --version`
- 检查权限：`sudo chmod 4755 /usr/local/bin/isolate`
- 检查沙箱目录：`ls /var/local/lib/isolate/`

---

## 附录

### A. 参考资料

- [Express官方文档](https://expressjs.com/)
- [MySQL2文档](https://github.com/sidorares/node-mysql2)
- [ioredis文档](https://github.com/luin/ioredis)
- [Bull队列文档](https://github.com/OptimalBits/bull)
- [isolate文档](https://github.com/ioi/isolate)
- [Winston日志文档](https://github.com/winstonjs/winston)

### B. 相关文档

- `README.md` - 项目说明文档
- `docs/数据库.md` - 数据库设计文档
- `docs/任务进度相关接口说明.md` - 接口说明文档

### C. 更新日志

- **v1.0.0** (2025-01-20)
  - 初始版本发布
  - 完整的OJ功能
  - 学习计划系统
  - 知识点管理

---

**文档版本**：v1.0.0  
**最后更新**：2025-01-20  
**维护者**：GESP开发团队

