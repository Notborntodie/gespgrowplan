# 任务进度相关接口说明

本文档说明本次更新中新增和修改的接口。

## 📋 目录

1. [任务内提交接口](#任务内提交接口)
2. [任务进度查询接口](#任务进度查询接口)
3. [教师查看接口（已更新）](#教师查看接口已更新)

---

## 🎯 任务内提交接口

### 1. 任务内提交客观题

**接口**: `POST /api/learning-tasks/:taskId/submit-exam`

**功能**: 在任务内提交客观题，自动更新任务和计划完成状态

**路径参数**:

- `taskId`: 任务ID

**请求体**:

```json
{
  "user_id": 123,
  "exam_id": 456,
  "answers": [
    {
      "question_id": 789,
      "user_answer": "A"
    }
  ]
}
```

**响应**:

```json
{
  "success": true,
  "message": "任务内客观题提交成功",
  "submission_id": 211,
  "score": 80,
  "total_questions": 25,
  "correct_count": 20,
  "attempt_number": 1,
  "answers": [...]
}
```

**说明**:

- 先返回提交结果给前端（快速响应）
- 异步更新任务和计划完成状态（不影响响应速度）
- 只有得分 >= 60 分才标记为完成
- 会创建 `submissions` 记录，并记录 `task_id`

---

### 2. 任务内提交OJ

**接口**: `POST /api/learning-tasks/:taskId/submit-oj`

**功能**: 在任务内提交OJ题目，自动更新任务和计划完成状态

**路径参数**:

- `taskId`: 任务ID

**请求体**:

```json
{
  "user_id": 123,
  "problem_id": 456,
  "code": "#include <iostream>\n...",
  "language": "cpp"
}
```

**响应**:

```json
{
  "success": true,
  "message": "任务内OJ提交成功",
  "submission_id": 397,
  "status": "completed",
  "verdict": "Accepted",
  "total_tests": 8,
  "passed_tests": 8,
  "results": [...]
}
```

**说明**:

- 先返回判题结果给前端（快速响应）
- 异步更新任务和计划完成状态（不影响响应速度）
- 只有 `verdict === 'Accepted'` 才标记为完成
- 会创建 `oj_submissions` 记录，并记录 `task_id`

---

## 📊 任务进度查询接口

### 3. 获取计划完成情况

**接口**: `GET /api/learning-plans/:planId/progress?user_id=xxx`

**功能**: 获取用户在某个计划内的详细完成情况

**路径参数**:

- `planId`: 计划ID

**查询参数**:

- `user_id`: 用户ID（必填）

**响应**:

```json
{
  "success": true,
  "data": {
    "plan": {
      "id": 12,
      "name": "测试学习计划",
      "description": "...",
      "level": 1,
      "start_time": "2025-11-13 15:18:29",
      "end_time": "2025-12-13 15:18:29",
      ...
    },
    "plan_progress": {
      "is_completed": false,
      "completed_tasks": 0,
      "total_tasks": 1,
      "progress_rate": 0,
      "completed_at": null
    },
    "tasks": [
      {
        "id": 41,
        "name": "测试任务",
        "task_progress": {
          "is_completed": false,
          "completed_at": null
        },
        "exam_progress": {
          "total": 1,
          "completed": 0,
          "exams": [...]
        },
        "oj_progress": {
          "total": 1,
          "completed": 0,
          "problems": [...]
        }
      }
    ]
  }
}
```

**说明**:

- 验证用户是否加入了该计划
- 返回计划基本信息
- 返回计划完成状态（从 `user_plan_progress` 表）
- 返回计划内所有任务的详细完成情况
- 包括每个任务的客观题和OJ题完成情况

---

x

**功能**: 获取用户在某个任务内的详细完成情况

**路径参数**:

- `taskId`: 任务ID

**查询参数**:

- `user_id`: 用户ID（必填）

**响应**:

```json
{
  "success": true,
  "data": {
    "task": {
      "id": 41,
      "name": "测试任务",
      "description": "...",
      ...
    },
    "task_progress": {
      "is_completed": false,
      "completed_at": null
    },
    "exam_progress": {
      "total": 1,
      "completed": 0,
      "exams": [
        {
          "id": 31,
          "name": "2025年3月GESP 4级真题",
          "is_completed": "0",
          "best_score": "20",
          "attempt_count": "2"
        }
      ]
    },
    "oj_progress": {
      "total": 1,
      "completed": 0,
      "problems": [
        {
          "id": 4,
          "title": "[GESP202506 一级] 假期阅读",
          "is_completed": "0",
          "best_verdict": "Partially Accepted",
          "attempt_count": "2"
        }
      ]
    }
  }
}
```

**说明**:

- 返回任务基本信息
- 返回任务完成状态
- 返回任务内所有客观题的完成情况
- 返回任务内所有OJ题的完成情况

---

### 5. 教师查看学生在计划内的完成情况

**接口**: `GET /api/learning-plans/:planId/students-progress?teacher_id=xxx`

**功能**: 教师查看所有学生在某个计划内的完成情况

**路径参数**:

- `planId`: 计划ID

**查询参数**:

- `teacher_id`: 教师ID（必填）

**响应**:

```json
{
  "success": true,
  "data": {
    "plan": {
      "id": 12,
      "name": "测试学习计划",
      ...
    },
    "students": [
      {
        "student_id": 129,
        "username": "test_student",
        "real_name": "测试学生",
        "plan_progress": {
          "is_completed": false,
          "completed_tasks": 0,
          "total_tasks": 1,
          "progress_rate": 0
        }
      }
    ]
  }
}
```

**说明**:

- 只返回该教师绑定的学生
- 返回每个学生的计划完成进度
- 返回各任务的完成情况统计

---

### 6. 教师查看单个学生的详细完成情况

**接口**: `GET /api/learning-plans/:planId/students/:studentId/progress?teacher_id=xxx`

**功能**: 教师查看单个学生在某个计划内的详细完成情况

**路径参数**:

- `planId`: 计划ID
- `studentId`: 学生ID

**查询参数**:

- `teacher_id`: 教师ID（必填）

**响应**:

```json
{
  "success": true,
  "data": {
    "student": {
      "id": 129,
      "username": "test_student",
      "real_name": "测试学生"
    },
    "plan_progress": {
      "is_completed": false,
      "completed_tasks": 0,
      "total_tasks": 1,
      "progress_rate": 0
    },
    "tasks": [
      {
        "id": 41,
        "name": "测试任务",
        "task_progress": {
          "is_completed": false
        },
        "exam_progress": {
          "total": 1,
          "completed": 0,
          "exams": [...]
        },
        "oj_progress": {
          "total": 1,
          "completed": 0,
          "problems": [...]
        }
      }
    ]
  }
}
```

**说明**:

- 验证教师-学生绑定关系
- 返回学生在该计划内所有任务的详细完成情况
- 包括每个任务的客观题和OJ题完成情况

---

## 👨‍🏫 教师查看接口（已更新）

以下接口已更新，现在会显示任务信息（`task_id`, `task_name`, `plan_name`）：

### 7. 获取学生答题情况

**接口**: `GET /api/teacher/:teacherId/students/:studentId/submissions`

**新增字段**:

- `task_id`: 任务ID（如果是在任务内提交）
- `task_name`: 任务名称
- `plan_name`: 计划名称

**说明**: 可以区分哪些提交是在任务内完成的，哪些是学生自主练习的

---

### 8. 获取教师绑定学生的全部提交记录

**接口**: `GET /api/teacher/:teacherId/submissions-list`

**新增字段**:

- `task_id`: 任务ID
- `task_name`: 任务名称
- `plan_name`: 计划名称

**查询参数**:

- `exam_id`: 考试ID（可选）
- `student_id`: 学生ID（可选）

---

### 9. 查看学生的某次提交详情

**接口**: `GET /api/teacher/:teacherId/students/:studentId/submissions/:submissionId`

**新增字段**:

- `task_id`: 任务ID
- `task_name`: 任务名称
- `plan_name`: 计划名称

---

### 10. 获取老师绑定学生的全部OJ提交记录

**接口**: `GET /api/teacher/:teacherId/oj-submissions`

**新增字段**:

- `task_id`: 任务ID
- `task_name`: 任务名称
- `plan_name`: 计划名称

**查询参数**:

- `studentId`: 学生ID（可选）
- `problemId`: 题目ID（可选）
- `page`: 页码（默认1）
- `pageSize`: 每页数量（默认20）
- `status`: 过滤状态（可选）
- `verdict`: 过滤结果（可选）

---

### 11. 查看学生的某次OJ提交详情

**接口**: `GET /api/teacher/:teacherId/students/:studentId/oj-submissions/:submissionId`

**新增字段**:

- `task_id`: 任务ID
- `task_name`: 任务名称
- `plan_name`: 计划名称

---

## ✅ 完成标准

### 客观题完成标准

- **完成条件**: 得分 >= 60 分
- **记录位置**: `user_exam_progress.is_completed = 1`

### OJ题完成标准

- **完成条件**: `verdict === 'Accepted'`
- **记录位置**: `user_oj_progress.is_completed = 1`

### 任务完成标准

- **完成条件**: 任务内所有客观题都完成（>= 60分）**且**所有OJ题都完成（Accepted）
- **记录位置**: `user_task_progress.is_completed = 1`

### 计划完成标准

- **完成条件**: 计划内所有任务都完成
- **记录位置**: `user_plan_progress.is_completed = 1`

---

## 🔄 异步更新机制

任务内提交接口采用异步更新机制：

1. **立即返回**: 提交结果立即返回给前端（快速响应）
2. **异步更新**: 使用 `setImmediate` 异步更新任务和计划完成状态
3. **不影响性能**: 前端响应速度不受影响

---

## 📝 数据库变更

### 新增字段

- `user_exam_progress.task_id`: 任务ID（NULL表示非任务内完成）
- `user_oj_progress.task_id`: 任务ID（NULL表示非任务内完成）
- `submissions.task_id`: 任务ID（NULL表示非任务内提交）
- `oj_submissions.task_id`: 任务ID（NULL表示非任务内提交）

### 新增表

- `user_plan_progress`: 用户计划完成进度表

---

## 🎯 使用场景

1. **学生提交任务内的题目**: 使用任务内提交接口，系统会自动记录 `task_id` 并更新进度
2. **学生自主练习**: 使用普通提交接口（`/submit-exam`, `/oj/submit`），`task_id` 为 NULL
3. **教师查看学生进度**: 使用教师查看接口，可以看到任务内和任务外的所有提交记录
4. **教师查看任务完成情况**: 使用计划进度查询接口，查看学生在计划内的完成情况

---

## ⚠️ 注意事项

1. 任务内提交会同时创建提交记录（`submissions`/`oj_submissions`）和进度记录（`user_exam_progress`/`user_oj_progress`）
2. 普通提交只创建提交记录，不创建进度记录（如果之前没有进度记录）
3. 完成标准严格执行：客观题必须 >= 60 分，OJ题必须 Accepted
4. 任务和计划的完成状态是异步更新的，可能有短暂延迟
